# Script de Base de Datos para AviculturaPWA en Supabase

Este script SQL está diseñado para ser ejecutado en el **Editor SQL** de tu proyecto de Supabase. Define la estructura de tablas, sus relaciones y políticas de seguridad básicas (Row Level Security) para el manejo de roles.

```sql
-- 1. Tabla de Fincas
CREATE TABLE fincas (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nombre TEXT NOT NULL,
  ubicacion TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 2. Tabla de Galpones
CREATE TABLE galpones (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  finca_id BIGINT NOT NULL REFERENCES fincas(id) ON DELETE CASCADE,
  nombre TEXT NOT NULL,
  capacidad INT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 3. Tabla de Cortes
CREATE TABLE cortes (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  galpon_id BIGINT NOT NULL REFERENCES galpones(id) ON DELETE CASCADE,
  fecha_inicio TIMESTAMPTZ NOT NULL,
  fecha_final TIMESTAMPTZ,
  numero_aves INT NOT NULL,
  tipo_ave TEXT,
  notas TEXT,
  estado TEXT NOT NULL DEFAULT 'activo', -- 'activo' o 'finalizado'
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 4. Tabla de Producción Diaria
CREATE TABLE produccion (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  corte_id BIGINT NOT NULL REFERENCES cortes(id) ON DELETE CASCADE,
  fecha TIMESTAMPTZ NOT NULL,
  huevos_y INT NOT NULL DEFAULT 0,
  huevos_aaa INT NOT NULL DEFAULT 0,
  huevos_aa INT NOT NULL DEFAULT 0,
  huevos_a INT NOT NULL DEFAULT 0,
  huevos_b INT NOT NULL DEFAULT 0,
  huevos_c INT NOT NULL DEFAULT 0,
  huevos_blancos INT NOT NULL DEFAULT 0,
  alimento NUMERIC, -- en kg
  muertes INT NOT NULL DEFAULT 0,
  notas TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);

-- 5. Tabla de Perfiles de Usuario para manejar roles
-- Esta tabla extiende la tabla 'auth.users' de Supabase
CREATE TABLE profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT,
  role TEXT NOT NULL CHECK (role IN ('administrador', 'operario')),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- 6. Tabla de Asignación de Galpones a Operarios (Muchos a Muchos)
CREATE TABLE operario_galpones (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  operario_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  galpon_id BIGINT NOT NULL REFERENCES galpones(id) ON DELETE CASCADE,
  UNIQUE (operario_id, galpon_id) -- Evita asignaciones duplicadas
);


-- -----------------------------------------------------------------------------
-- POLÍTICAS DE SEGURIDAD (ROW LEVEL SECURITY - RLS)
-- Es crucial habilitar RLS en cada tabla desde el dashboard de Supabase.
-- -----------------------------------------------------------------------------

-- Habilitar RLS en todas las tablas
ALTER TABLE fincas ENABLE ROW LEVEL SECURITY;
ALTER TABLE galpones ENABLE ROW LEVEL SECURITY;
ALTER TABLE cortes ENABLE ROW LEVEL SECURITY;
ALTER TABLE produccion ENABLE ROW LEVEL SECURITY;
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE operario_galpones ENABLE ROW LEVEL SECURITY;

-- --- Políticas para la tabla 'profiles' ---
-- Los usuarios pueden ver su propio perfil.
CREATE POLICY "Los usuarios pueden ver su propio perfil" ON profiles
  FOR SELECT USING (auth.uid() = id);
-- Los administradores pueden ver todos los perfiles.
CREATE POLICY "Los administradores pueden ver todos los perfiles" ON profiles
  FOR SELECT USING (EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'administrador'));
-- Los usuarios pueden actualizar su propio perfil.
CREATE POLICY "Los usuarios pueden actualizar su propio perfil" ON profiles
  FOR UPDATE USING (auth.uid() = id);


-- --- Políticas para la tabla 'fincas' ---
-- Solo los administradores pueden gestionar fincas.
CREATE POLICY "Los administradores pueden gestionar fincas" ON fincas
  FOR ALL USING (EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'administrador'));


-- --- Políticas para la tabla 'galpones' ---
-- Los administradores pueden gestionar galpones.
CREATE POLICY "Los administradores pueden gestionar galpones" ON galpones
  FOR ALL USING (EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'administrador'));
-- Los operarios pueden ver los galpones que tienen asignados.
CREATE POLICY "Los operarios pueden ver sus galpones asignados" ON galpones
  FOR SELECT USING (EXISTS (
    SELECT 1 FROM operario_galpones WHERE galpon_id = id AND operario_id = auth.uid()
  ));


-- --- Políticas para la tabla 'cortes' ---
-- Los administradores pueden gestionar cortes.
CREATE POLICY "Los administradores pueden gestionar cortes" ON cortes
  FOR ALL USING (EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'administrador'));
-- Los operarios pueden ver los cortes de sus galpones asignados.
CREATE POLICY "Los operarios pueden ver los cortes de sus galpones" ON cortes
  FOR SELECT USING (EXISTS (
    SELECT 1 FROM operario_galpones WHERE galpon_id = cortes.galpon_id AND operario_id = auth.uid()
  ));


-- --- Políticas para la tabla 'produccion' ---
-- Los administradores pueden gestionar toda la producción.
CREATE POLICY "Los administradores pueden gestionar la produccion" ON produccion
  FOR ALL USING (EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'administrador'));
-- Los operarios pueden gestionar la producción de los cortes en sus galpones asignados.
CREATE POLICY "Los operarios pueden gestionar la produccion de sus galpones" ON produccion
  FOR ALL USING (EXISTS (
    SELECT 1 FROM cortes c
    JOIN operario_galpones og ON c.galpon_id = og.galpon_id
    WHERE c.id = produccion.corte_id AND og.operario_id = auth.uid()
  ));

-- --- Políticas para 'operario_galpones' (asignaciones) ---
-- Solo los administradores pueden gestionar las asignaciones.
CREATE POLICY "Los administradores pueden gestionar asignaciones" ON operario_galpones
  FOR ALL USING (EXISTS (SELECT 1 FROM profiles WHERE id = auth.uid() AND role = 'administrador'));

```
